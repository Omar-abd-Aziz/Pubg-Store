<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>طلباتي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
    <link rel="stylesheet" href="./css/framework.css" />
    <link rel="stylesheet" href="./css/master.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;500&display=swap" rel="stylesheet" />


    <link rel="icon" type="image/x-icon" href="./imgs/pubg icon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-precise-range-plugin@1.3.0/moment-precise-range.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">


    <style>

        body{
            min-width: 900px;
            overflow: scroll;
        }

        @media (max-width: 900px) {
            .head{
                display: none;
            }
            body > div > div.sidebar.bg-white.p-20.p-relative > div{
                display: none;
            }

            body > div > div.sidebar.bg-white.p-20.p-relative > ul > li > a:nth-child(1) > p{
                display: none;
            }
        }

        #note{
          font-size: 20px;
          font-weight: bold;
        }

      @font-face {
        font-family: myFirstFont;
        src: url(./Fonts/Ethnocentric.ttf);
      }

      
      /* Table Styles */

      .table-wrapper{
          box-shadow: 0px 35px 50px rgba( 0, 0, 0, 0.2 );
      }

      .fl-table {
          border-radius: 5px;
          font-size: 17px;
          font-weight: normal;
          border: none;
          border-collapse: collapse;
          width: 100%;
          max-width: 100%;
          white-space: nowrap;
          background-color: white;
      }

      .fl-table td{
          text-align: center;
          padding: 3px;
          border: 2px solid #0a1951;
      }


      .fl-table th {
          text-align: center;
          padding: 8px;
          border: 2px solid #0a1951;
      }


      .fl-table td {
          border-right: 1px solid #f8f8f8;
          font-size: 14px;
          font-family: 'Cairo';
      }


      .fl-table thead th {
          color: #ffffff;
          background: #0a1951;
      }

      .fl-table tr {
        border: 1px solid rgb(0, 0, 0);
      }

      /* Responsive */


      @media (max-width: 400px){
        
          body > div.swal2-container.swal2-center.swal2-backdrop-show > div{
            max-width: 320px !important;
          }

      }




      .CompanyName::before{
        content: "Digital vision for information technology";
        position: relative;
        bottom: -28px;
        left: 300px;
        font-family: myFirstFont;
        color: #397eaf;
        font-size: 13px;
      }


      .OrderActiveNote{
        width: 98%;
        border: 2px solid black;
        border-radius: 6px;
        padding: 10px;
        font-size: 20px;
      }


      .OrderActiveNoteTwo{
        width: 98%;
        border: 2px solid black;
        border-radius: 6px;
        padding: 10px;
        font-size: 20px;
      }













    </style>

  </head>
  <body>
    <div class="page d-flex">
      
      <div class="content w-full">
        
        <!-- Start Head -->
        <div class="head bg-white between-flex" style="padding: 0px 10px 15px; background: #f1f5f9;">
          <div class="p-relative">
            <h1 class="p-relative" style="text-align: center;">طلباتي</h1>
          </div>
          <div class="icons d-flex align-center">
            <p class="CompanyName" style="font-weight: bold; font-size: 20px; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;"> الرؤيا الرقمية لتقنية المعلومات </p>
            <img src="./imgs/logo.png" alt="" />
          </div>
        </div>
        <!-- End Head -->

        <div style="display: flex;align-items: center;justify-content: space-between;">
          <div></div>
          <button style="font-size: 18px; font-family:cairo; cursor:pointer; width: 120px; margin: 20px; border-radius: 10px; background: #0a1951; color: white; padding: 5px 0px; font-weight: 600;" class="addNewOrder">اضافة طلب</button>
        </div>

        <div style="overflow: auto;">

          <div class="table-wrapper">
            <table class="fl-table">
                <thead>
                <tr>
                    <th>التفاصيل</th>
                    <th>التاريخ</th>
                    <th>المبلغ</th>
                    <th>النشاط</th>
                    <th>المدينة</th>
                    <th>رقم جوال العميل</th>
                    <th>اسم العميل</th>
                    <th>رقم الطلب</th>
                    <th>#</th>
                </tr>
                </thead>

                <tbody id="AllOrders">
                
                <tbody>
            </table>
        </div>
          
        </div>

      </div>


      <!-- Start Sidebar can copy it to anthor file -->
      <div class="sidebar bg-white p-20 p-relative">
        <div>
          <i class="fa-regular fa-circle-user fa-fw" style="font-weight: bold;font-size: 50px;width: 100%;"></i>
          <h2>Hello <span id="AdminName" style="color: #397eaf"></span></h2>
        </div>
        <ul>
          
          <li>

            <a class="active d-flex align-center fs-14 c-black rad-6 p-10" style="display: flex; justify-content: end;" href="Dashboard-notAdmin.html">
              <p style="position: absolute; left: 35px; font-weight: bold;" class="NumberOfOrders">0</p>
              <span style="font-weight: bold; font-size:20px;">طلباتي</span>
              <i class="fa-regular fa-circle-user fa-fw" style="font-weight: bold; font-size:20px; margin-left: 10px;"></i>
            </a>


            <a class="Orders-Accepted active d-flex align-center fs-14 c-black rad-6 p-10" style="display: flex; justify-content: end; cursor: pointer; background: rgba(137, 8, 8, 0.676); color: white;" id="logOut-digital">
              <span style="font-weight: bold; font-size:20px;">تسجيل الخروج</span>
              <i class="fas fa-sign-out-alt fa-fw" style="font-weight: bold; font-size:20px; margin-left: 10px; color: white;"></i>
            </a>

          </li>
          
        </ul>
      </div>
      <!-- End Sidebar can copy it to anthor file -->

    </div>
  </body>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-database.js"></script>

  <script type="module">


  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js';
  import { getFirestore, collection, query, where, getDocs,getDoc, setDoc, addDoc, doc,deleteDoc,onSnapshot } from 'https://www.gstatic.com/firebasejs/9.8.2/firebase-firestore.js';

  // TODO: Replace the following with your app's Firebase project configuration
 
  
  import { firebaseConfig } from './firebase.js';

  firebase.initializeApp(firebaseConfig);
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let X;

  async function getCit(db,X) {
  const citiesCol = collection(db,`${X}`);
  const citySnapshot = await getDocs(citiesCol);
  const cityList = citySnapshot.docs.map(doc => doc.data());
  return cityList;
  };






/* start return all orders by the user */

let AllOrdersByTheUser;
let AllPersonsData;
async function ForAllOrdersByTheUser(){

  const q = query(collection(db, "Persons"), where("orderByUser", "==", mainPersonData.name));
  const querySnapshot = await getDocs(q);
  const cityList = querySnapshot.docs.map(doc => doc.data());

  AllOrdersByTheUser=cityList.sort(function(a, b) {
    return a.date - b.date;
  });

  AllOrdersByTheUser=AllOrdersByTheUser.reverse();
  AllPersonsData=AllOrdersByTheUser;
  return AllOrdersByTheUser;
};

/* end return all orders by the user */








//////////////////////////////////////////////////////////////////////////








/*start login cods*/






/* 02 start get AllAccounts */

let AllAccounts;

await getCit(db, 'accounts').then(async (e) => {
  AllAccounts = e;
})

async function getUserDataWithId(id){
  return AllAccounts.find(e=>e.id==id);
}

/* 02 end get All Accounts */



/* 04 start check and get user doc */

let mainPersonData;
let docId = await localStorage.getItem("doc-digital-id");

if(docId!==null&&docId.trim()!==''){

    mainPersonData=await getUserDataWithId(docId);

    if(mainPersonData.isAdmin==true){
      location.href="./Dashboard-Orders.html";
    };

    document.querySelector("#AdminName").textContent=`${mainPersonData.name}..`;
} else {
  location.href="./login/login.html"
}

/* 04 end check and get user doc */



document.querySelector("#logOut-digital").addEventListener("click",()=>{

  localStorage.setItem("doc-digital-id","");
  location.href="./login/login.html";

});


/*end login cods*/






  
/* 2 start function to get differnce between data now */
function getDiffDate(oldDate){
        
    var starts = moment(`${oldDate}`);
    var ends   = moment();

    var duration = moment.duration(ends.diff(starts));

    // with ###moment precise date range plugin###
    // it will tell you the difference in human terms

    var diff = moment.preciseDiff(starts, ends, true); 
    // example: { "years": 2, "months": 7, "days": 0, "hours": 6, "minutes": 29, "seconds": 17, "firstDateWasLater":  false }


    // or as string:
    var diffHuman = moment.preciseDiff(starts, ends);
    // example: 2 years 7 months 6 hours 29 minutes 17 seconds

    let diffDate=diff;

    if(diffDate.years!==0){
        diffDate={
            "diffDateNum": diffDate.years,
            "diffDateName": "سنة",
        };
    } else if(diff.months!==0){
        diffDate={
            "diffDateNum": diffDate.months,
            "diffDateName": "شهر",
        };
    } else if(diff.days!==0){
        diffDate={
            "diffDateNum": diffDate.days,
            "diffDateName": "يوم",
        };
    } else if(diff.hours!==0){
        diffDate={
            "diffDateNum": diffDate.hours,
            "diffDateName": "ساعة",
        };
    } else if(diff.minutes!==0){
        diffDate={
            "diffDateNum": diffDate.minutes,
            "diffDateName": "دقيقة",
        };
    } else {
        diffDate={
            "diffDateNum": 0,
            "diffDateName": "الان",
        };
    }

    let stringDiffDate = `منذ ${diffDate.diffDateNum + " " + diffDate.diffDateName}`;
    // منذ 1 سنة

    if(diffDate.diffDateName=="الان"){
      stringDiffDate="الان";
    }
    
    // diffDate => json like {diffDateNum: 1, diffDateName: 'سنة'}

    return stringDiffDate;
}

// console.log(getDiffDate("2022/1/1 => 5:55 PM"));

/* 2 end function to get differnce between data now */









/* 3 start get all Orders */



async function getAllOrdersByTheUser(){
  
  
  await ForAllOrdersByTheUser().then(AllOrdersByTheUser=>{
        let i = 0;

        document.querySelector(".NumberOfOrders").innerHTML=AllOrdersByTheUser.length;
  
        if(AllOrdersByTheUser.length!==0){
          document.querySelector("#AllOrders").innerHTML="";
        }
  
        console.log(AllOrdersByTheUser)
        AllOrdersByTheUser.forEach(el=>{
            let I=0;
            if((el.name).trim()!==""&&(el.phone).trim()!==""&&(el.active).trim()!==""&&(el.city).trim()!==""){
              i++;
              document.querySelector("#AllOrders").innerHTML+=`
  
  
                  <tr data-id="${el.id}" style="font-weight: 600;">
                    <td>

                      <a>
                        <i title="حالة الطلب" class="${(el.isAccepted==true)?'fa-sharp fa-solid fa-check':'fa-solid fa-spinner'}" style="font-size: 25px; color: #233245; background: white; border-radius: 50%; padding: 5px 5px;"></i>
                      </a>

                      <a>
                        <i title="تفاصيل الطلب" class="fa-sharp fa-solid fa-circle-info Order-Note" data-id="${el.id}" data-note="${el.note}" style="font-size: 25px; color: #233245; background: white; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
                      </a>


                      ${(el.isAccepted=="Orders-New")?`
                      <a>
                        <i title="تحويل لطلبات التفعيل" class="fa-solid fa-check activeOrder" data-id="${el.id}" style="position: relative; top: -3px; font-size: 15px; color: white; background: #1877f2; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
                      </a>
                      `:``}
                      

                      <a>
                        <i title="تفاصيل كود التفعيل" class="fa-sharp fa-solid fa-circle-info Order-Active-Note" data-id="${el.id}" style="font-size: 25px; color: #1877f2; background: white; border-radius: 50%; padding: 5px 5px; cursor: pointer;"></i>
                      </a>

                    </td>
                    <td class="Order-Date">${getDiffDate(el.orderDate)}</td>
                    <td class="Order-Price">${(el.price==undefined)?0:el.price}</td>
                    <td class="Order-Active">${el.active}</td>
                    <td class="Order-City">${el.city}</td>
                    <td class="Order-Phone">${el.phone}</td>
                    <td class="Order-Name">${el.name}</td>
                    <td class="Order-Number">${el.orderNumber}</td>
                    <td class="Order-Id">#${i}</td>
                  </tr>
              
              `;
            }
        });
    });



};


/* 3 End get all Orders */


window.onclick=(e)=>{

    /* btn to detals*/
    if([...e.target.classList].includes("Order-Note")){
    Swal.fire(
        `${e.target.dataset.note}`
        );
    };





/* start active order */



if([...e.target.classList].includes("activeOrder")){

let orderId=e.target.dataset.id;
let orderData=AllPersonsData.find(el=>el.id==`${orderId}`);

Swal.fire({
  title: 'قم بكتابة كود التفعيل',
  html: `
  
  <textarea style="width: 98%;" rows="10" class="OrderActiveNote" type="text" dir="auto" autocomplete="off"></textarea>
  
  `,
  confirmButtonText: 'حفظ وتحويل لطلبات التفعيل',
  showCancelButton: true
}).then((result)=>{

  let OrderActiveNote = document.querySelector(".OrderActiveNote").value
  OrderActiveNote=OrderActiveNote.trim();

  if (result.isConfirmed && OrderActiveNote!=="") {
    
    console.log(orderData);

    setDoc(doc(db,"Persons",orderData.id), {
      ...orderData,
      OrderActiveNote: `${OrderActiveNote}`,
      isAccepted: "Orders-Actives",
    }).then(e=>{
      Swal.fire(
        'تم التحويل لطلبات التفعيل',
        '',
        'success'
      );
    });

  } else if(OrderActiveNote=="") {
    Swal.fire(
      'برجاء كتابة كود التفعيل',
      '',
      'error'
    );
  };

});



};




/* end active order */




/* start order detals btn*/
if([...e.target.classList].includes("Order-Active-Note")){
  let orderId=e.target.dataset.id;
  let orderData=AllPersonsData.find(el=>el.id==`${orderId}`);
  let OrderActiveNote=orderData.OrderActiveNote;
  OrderActiveNote=OrderActiveNote.trim();
  Swal.fire({
    title: 'كود التفعيل',
    html: `
    
    <textarea style="width: 98%;" rows="5" class="OrderActiveNote" type="text" dir="auto" autocomplete="off" readonly>${orderData.OrderActiveNote}</textarea>
    <br>
    <textarea style="width: 98%;" rows="5" class="OrderActiveNoteTwo" type="text" dir="auto" autocomplete="off" readonly>${orderData.OrderActiveNoteTwo}</textarea>
    
    `,
    confirmButtonText: 'Ok',
  })
}
/* end order detals btn*/
















};








/* 5 start add new order */

document.querySelector(".addNewOrder").addEventListener("click",()=>{


  Swal.fire({
      title: ' اضافة طلب جديد ',
      html: `
      
      
      <div class="mainForm" style="overflow-y: hidden; overflow-c: scroll; font-size: 17px!important; font-family: 'Cairo', sans-serif; font-weight: bold!important;">

          <label for="name">:اسم العميل</label>
          <input style="width: 98%;" class="addOrderInput" type="text" dir="auto" autocomplete="off" id="name" value="">

          <label for="phone">رقم جوال العميل:</label>
          <input style="width: 98%;" class="addOrderInput" type="number" placeholder="" dir="auto" autocomplete="off" id="phone" value="">

          <label for="active">النشاط:</label>
          <select value="" dir="auto" id="active" class="addOrderInput" name="carlist" form="carform" style="font-weiht: bold; padding: 5px 5px; width: 98%; margin: auto 10px auto 0px; border: 2px solid black; border-radius: 6px;">
              <option value=""></option>
              <option value="مواد البناء والكهرباء والسباكة">
                مواد البناء والكهرباء والسباكة
              </option>
              <option value="محلات قطع الغيار">
                محلات قطع الغيار
              </option>
              <option value=" محلات السوبر ماركت ">
                محلات السوبر ماركت
              </option>
              <option value="المطاعم والوجبات السريعة">
                المطاعم والوجبات السريعة 
              </option>
              <option value="المكتبات">
                المكتبات
              </option>
              <option value="الملابس الجــاهزة">
                الملابس الجــاهزة
              </option>
              <option value="الاسواق التجارية">
                الاسواق التجارية
              </option>
              <option value=" الأدوات المنزلية ">
                الأدوات المنزلية
              </option>
              <option value="شركات المقاولات">
                شركات المقاولات
              </option>
              <option value="الصيدليات">
                الصيدليات
              </option>
              <option value="الملابس الرياضية">
                الملابس الرياضية
              </option>
              <option value="المفروشات">
                المفروشات
              </option>
              <option value="الأحذية و المصنوعات الجلدية">
                الأحذية و المصنوعات الجلدية
              </option>
              <option value="الساعات والهدايا والكماليات">
                الساعات والهدايا والكماليات
              </option>
              <option value="العطور وادوات التجميل">
                 العطور وأدوات التجميل
              </option>
              <option value="الكومبيوتر والالكترونيات">
                الكومبيوتر والالكترونيات
              </option>
              <option value="الأجهزة والأدوات الكهـ ربائية">
                الأجهزة والأدوات الكهـربائية
              </option>
              <option value="شي اخر">
              شي اخر..
              </option>
          </select>


          <label for="active-V">الاصدار:</label>
          <select value="" dir="auto" id="active-V" class="addOrderInput" name="carlist" form="carform" style="font-weiht: bold; padding: 5px 5px; width: 98%; margin: auto 10px auto 0px; border: 2px solid black; border-radius: 6px;">
              <option value="V.1">
                V.1  _ 850 ريال
              </option>
              <option value="V.2">
                V.2  _  ريال 950 
              </option>
              <option value="V.3">
                V.3  _  1000 ريال
              </option>
              <option value="V.4">
                V.4  _  1250 ريال
              </option>
              <option value="V.5">
                V.5  _  1500 ريال
              </option>
              <option value="V.6">
                V.6  _  2000 ريال
              </option>
          </select>

          <label for="city">المدينة:</label>
          <input style="width: 98%;" class="addOrderInput" type="text" dir="rtl" autocomplete="off" id="city" value="">

          <label for="endTime"> التفاصيل </label>
          <textarea type="text" dir="rtl" autocomplete="off" id="note" value="" rows="4" style="width: 98%; border: 2px solid black; border-radius: 6px;"></textarea>


      </div>
      
      
      `,
      confirmButtonText: 'اضافة',
  }).then((result) => {    
      if (result.isConfirmed) {

          let name=document.querySelector("#name").value;
          let phone=document.querySelector("#phone").value;
          let active=document.querySelector("#active").value;
          let activeV=document.querySelector("#active-V").value;
          let city=document.querySelector("#city").value;
          let note=document.querySelector("#note").value;

          let price;

          if(activeV=="V.1"){
            price = 850;
          }else if(activeV=="V.2"){
            price = 950;
          }else if(activeV=="V.3"){
            price = 1000;
          }else if(activeV=="V.4"){
            price = 1250;
          }else if(activeV=="V.5"){
            price = 1500;
          }else if(activeV=="V.6"){
            price = 2000;
          }



          if(name!==""&&phone!==""&&active!==""&&activeV!==""&&city!==""){

          let id = idGenerator();

          AddNewOrder(name,phone,active,activeV,city,price,note,id);

          } else {
            Swal.fire(
                'قم بملي البيانت بشكل صحيح',
                '',
                'error'
            )

          }


          function idGenerator() {
            var S4 = function() {
              return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
            };
            return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
          };
          

          function AddNewOrder(name,phone,active,activeV,city,price,note,id){
            let randomOrderNumber = (Math.random()*1000000).toFixed();


            /* Start Send Whatsapp Massage */

            let HelloMassage=`

عميلنا العزيز ( ${name} )
تم استلام طلبك ( ${active} )
رقم الطلب : ${randomOrderNumber}
الرجاء الاحتفاظ بهذه الرسالة وسوف يقوم فريقنا بالتواصل معك فور التاكد من بيانات طلبك
سعدنا بخدمتك يومك سعيد

            `;
                
            HelloMassage=HelloMassage.trim();
            let whatappAPI=`https://karzoun.app/api/send.php?number=966${Number(`${phone}`)}&type=text&message=${encodeURIComponent(HelloMassage)}&instance_id=63C2CA489C2CA&access_token=1757991908`;
            
            // fetch(whatappAPI);

            /* End Send Whatsapp Massage */

            setDoc(doc(db,"Persons",id), {
              id: id,
              name: name,
              phone: phone,
              city: city,
              active: active,
              activeV: activeV,
              price: price,
              country_calling_code: "+966",
              date: Date.now(),
              orderDate: showDate(),
              orderNumber: randomOrderNumber,
              note: note,
              orderByUser: mainPersonData.name,
              isAccepted: "Orders-New",
            }).then(e=>{
              Swal.fire(
                'تم اضافة الطلب',
                '',
                'success'
              )
            });

          };
          
      };
  });

});


/* 5 end add new order */






/* 1 start function to get data now */
function showDate(){
  
  const d = new Date();
  
  let year = d.getFullYear();
  let month = d.getMonth();
  let day = d.getDate();
  let hour = d.getHours();
  let mint = d.getMinutes();
  
  if(mint<10){
    mint=`0${mint}`
  }
  
  let dateNow;

  console.log(hour)

  if (hour>=12){
    
    dateNow= `
      ${year}/${month+1}/${day}
      => ${hour-12}:${mint} PM
      `;

  } else if (hour<=11){
    
      dateNow = `
      
      ${year}/${month+1}/${day}
         ${hour}:${mint} AM
      
      `;
  }
  return dateNow;
}

/* 1 end function to get data now */






const colRef= collection(db,"Persons");

onSnapshot(colRef,async()=>{
  getAllOrdersByTheUser();
});



</script>

</html>
